{% extends 'base.html' %}
{% block title %}{{ project.title }} - ProjectHub{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav class="flex mb-4 md:mb-6" aria-label="Breadcrumb">
  <ol class="inline-flex items-center space-x-1 md:space-x-2 flex-wrap">
    <li class="inline-flex items-center">
      <a href="{% url 'project-list-page' %}" class="inline-flex items-center text-sm font-medium text-slate-700 hover:text-sky-600">
        <svg class="w-4 h-4 mr-1 md:mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
        </svg>
        <span class="hidden sm:inline">Projects</span>
      </a>
    </li>
    <li aria-current="page">
      <div class="flex items-center">
        <svg class="w-5 h-5 md:w-6 md:h-6 text-slate-400" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        <span class="ml-1 text-sm font-medium text-slate-500 md:ml-2 truncate max-w-[150px] md:max-w-none">{{ project.title|truncatechars:30 }}</span>
      </div>
    </li>
  </ol>
</nav>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-8">
  <!-- Main Content -->
  <div class="lg:col-span-2 space-y-4 md:space-y-6">
    <!-- Project Header -->
    <div class="bg-gradient-to-r from-sky-50 to-white rounded-xl md:rounded-2xl p-4 md:p-6 border border-sky-100">
      <div class="flex flex-col sm:flex-row sm:items-start justify-between gap-3 md:gap-4">
        <div class="flex-1 min-w-0">
          <h1 class="text-xl md:text-2xl font-bold text-slate-900 mb-2">{{ project.title }}</h1>
          <div class="flex flex-wrap items-center gap-2 text-xs md:text-sm text-slate-600 mb-3 md:mb-4">
            <span class="inline-flex items-center bg-sky-100 text-sky-800 px-2 md:px-3 py-1 rounded-full text-xs">
              <svg class="w-3 h-3 md:w-4 md:h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"/>
              </svg>
              {{ project.department }}
            </span>
            <span class="inline-flex items-center bg-slate-100 text-slate-800 px-2 md:px-3 py-1 rounded-full text-xs">
              {{ project.course }}
            </span>
            <span class="inline-flex items-center text-xs md:text-sm">
              <svg class="w-3 h-3 md:w-4 md:h-4 mr-1 text-slate-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd"/>
              </svg>
              <span class="truncate max-w-[100px] md:max-w-none">{{ project.institution }}</span>
            </span>
            <span class="inline-flex items-center text-xs md:text-sm">
              <svg class="w-3 h-3 md:w-4 md:h-4 mr-1 text-slate-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
              </svg>
              {{ project.year }}
            </span>
          </div>
        </div>
        <div class="flex items-center justify-end sm:justify-start">
          <span class="text-xs font-medium text-slate-500 bg-slate-100 px-2 md:px-3 py-1 md:py-1.5 rounded-full">
            <span class="inline-flex items-center">
              <svg class="w-3 h-3 md:w-4 md:h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"/>
                <path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"/>
              </svg>
              {{ project.download_count }} downloads
            </span>
          </span>
        </div>
      </div>
    </div>

    <!-- Abstract Section -->
    <div class="bg-white rounded-xl md:rounded-2xl border border-slate-200 p-4 md:p-6">
      <div class="flex items-center mb-3 md:mb-4">
        <div class="w-1.5 h-5 md:h-6 bg-sky-500 rounded-full mr-2 md:mr-3"></div>
        <h2 class="text-base md:text-lg font-semibold text-slate-900">Abstract</h2>
      </div>
      <div class="prose prose-slate max-w-none text-sm md:text-base">
        <p class="text-slate-700 leading-relaxed whitespace-pre-line">{{ project.abstract }}</p>
      </div>
    </div>

    <!-- Additional Info -->
    {% if project.file_format or project.page_count or project.chapters %}
    <div class="bg-white rounded-xl md:rounded-2xl border border-slate-200 p-4 md:p-6">
      <h3 class="text-base md:text-lg font-semibold text-slate-900 mb-3 md:mb-4">Project Details</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 md:gap-4">
        {% if project.file_format %}
        <div class="bg-slate-50 rounded-lg p-3 md:p-4">
          <div class="text-xs md:text-sm text-slate-500 mb-1">Format</div>
          <div class="font-medium text-slate-900 text-sm md:text-base">{{ project.file_format|upper }}</div>
        </div>
        {% endif %}
        {% if project.page_count %}
        <div class="bg-slate-50 rounded-lg p-3 md:p-4">
          <div class="text-xs md:text-sm text-slate-500 mb-1">Pages</div>
          <div class="font-medium text-slate-900 text-sm md:text-base">{{ project.page_count }}</div>
        </div>
        {% endif %}
        {% if project.chapters %}
        <div class="bg-slate-50 rounded-lg p-3 md:p-4">
          <div class="text-xs md:text-sm text-slate-500 mb-1">Chapters</div>
          <div class="font-medium text-slate-900 text-sm md:text-base">{{ project.chapters }}</div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Sidebar -->
  <div class="lg:col-span-1">
    <div class="sticky top-4 md:top-6 space-y-4 md:space-y-6">
      <!-- Purchase Card -->
      <div class="bg-white rounded-xl md:rounded-2xl border border-slate-200 shadow-lg overflow-hidden">
        <div class="p-4 md:p-6">
          <div class="text-center mb-4 md:mb-6">
            <div class="text-2xl md:text-3xl font-bold text-sky-700 mb-1">₦{{ project.price }}</div>
            <div class="text-xs md:text-sm text-slate-500">One-time purchase</div>
          </div>

          <div class="space-y-3 md:space-y-4 mb-4 md:mb-6">
            <div class="flex items-center text-xs md:text-sm">
              <svg class="w-4 h-4 md:w-5 md:h-5 text-green-500 mr-2 md:mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-slate-700">Full project with source code</span>
            </div>
            <div class="flex items-center text-xs md:text-sm">
              <svg class="w-4 h-4 md:w-5 md:h-5 text-green-500 mr-2 md:mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-slate-700">Documentation & Abstract</span>
            </div>
            <div class="flex items-center text-xs md:text-sm">
              <svg class="w-4 h-4 md:w-5 md:h-5 text-green-500 mr-2 md:mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              <span class="text-slate-700">Instant download after payment</span>
            </div>
          </div>

          <button id="purchaseButton" data-project-id="{{ project.id }}"
            class="w-full py-2.5 md:py-3.5 px-3 md:px-4 bg-gradient-to-r from-sky-600 to-sky-500 hover:from-sky-700 hover:to-sky-600 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center text-sm md:text-base">
            <svg id="purchaseSpinner" class="hidden w-4 h-4 md:w-5 md:h-5 mr-2 animate-spin text-white" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="purchaseText">Purchase & Download Now</span>
          </button>

          <div class="mt-3 md:mt-4 text-center">
            <div class="flex items-center justify-center text-xs text-slate-500">
              <svg class="w-3 h-3 md:w-4 md:h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
              </svg>
              Secure payment via Paystack
            </div>
          </div>
        </div>
      </div>

      <!-- Help Card -->
      <div class="bg-sky-50 rounded-xl md:rounded-2xl border border-sky-100 p-3 md:p-5">
        <div class="flex items-start">
          <svg class="w-5 h-5 md:w-6 md:h-6 text-sky-600 mt-0.5 mr-2 md:mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
          </svg>
          <div>
            <h4 class="text-sm font-semibold text-sky-900 mb-1">Need help?</h4>
            <p class="text-xs md:text-sm text-sky-700">Contact our support team if you have any questions about this project.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Similar Projects (Optional) -->
{% if similar_projects %}
<div class="mt-8 md:mt-12">
  <h3 class="text-lg md:text-xl font-semibold text-slate-900 mb-4 md:mb-6">Similar Projects</h3>
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
    {% for similar in similar_projects %}
    <a href="{% url 'project-detail' slug=similar.slug %}" 
       class="bg-white rounded-lg md:rounded-xl border border-slate-200 p-4 md:p-5 hover:border-sky-300 hover:shadow-md transition-all duration-200">
      <h4 class="font-medium text-slate-900 mb-2 line-clamp-2 text-sm md:text-base">{{ similar.title }}</h4>
      <div class="flex items-center justify-between text-xs md:text-sm text-slate-600">
        <span class="truncate max-w-[100px]">{{ similar.department }}</span>
        <span class="font-semibold text-sky-700">₦{{ similar.price }}</span>
      </div>
    </a>
    {% endfor %}
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
  const purchaseButton = document.getElementById('purchaseButton');
  const purchaseSpinner = document.getElementById('purchaseSpinner');
  const purchaseText = document.getElementById('purchaseText');

  purchaseButton?.addEventListener('click', async function () {
    const projectId = this.dataset.projectId;

    // Check if user is logged in
    {% if user.is_authenticated %}
    const isLoggedIn = true;
    {% else %}
    const isLoggedIn = false;
    {% endif %}

    if (!isLoggedIn) {
      window.location.href = '/login/?next=' + encodeURIComponent(window.location.pathname);
      return;
    }

    // Get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    try {
      // Show loading state
      purchaseButton.disabled = true;
      purchaseSpinner.classList.remove('hidden');
      purchaseText.textContent = 'Processing...';

      const resp = await fetch('/api/payments/init/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken,
        },
        credentials: 'include',
        body: JSON.stringify({ project_id: Number(projectId) }),
      });

      const data = await resp.json();
      
      if (!resp.ok) {
        // Show error message
        const errorMessage = data.detail || 'Unable to start payment. Please try again.';
        showNotification(errorMessage, 'error');
        
        // Reset button
        purchaseButton.disabled = false;
        purchaseSpinner.classList.add('hidden');
        purchaseText.textContent = 'Purchase & Download Now';
        return;
      }

      // Redirect to Paystack authorization URL
      if (data.authorization_url) {
        window.location.href = data.authorization_url;
      } else if (data.id) {
        // Free project - already purchased
        showNotification('Project purchased successfully! You can now download it.', 'success');
        setTimeout(() => window.location.reload(), 1500);
      }
    } catch (err) {
      console.error(err);
      showNotification('Network error while initializing payment. Please check your connection.', 'error');
      
      // Reset button
      purchaseButton.disabled = false;
      purchaseSpinner.classList.add('hidden');
      purchaseText.textContent = 'Purchase & Download Now';
    }
  });

  function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 left-4 md:left-auto z-50 px-4 py-3 rounded-lg shadow-lg border transform transition-all duration-300 ${
      type === 'error' 
        ? 'bg-red-50 border-red-200 text-red-800' 
        : 'bg-green-50 border-green-200 text-green-800'
    }`;
    
    notification.innerHTML = `
      <div class="flex items-center">
        <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
          ${type === 'error' 
            ? '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>'
            : '<path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>'
          }
        </svg>
        <span class="text-sm font-medium">${message}</span>
      </div>
    `;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Remove after 5 seconds
    setTimeout(() => {
      notification.style.transform = 'translateX(100%)';
      notification.style.opacity = '0';
      setTimeout(() => notification.remove(), 300);
    }, 5000);
  }
</script>
{% endblock %}