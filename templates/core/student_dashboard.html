{% extends 'base.html' %}
{% block title %}My Dashboard - ProjectHub{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl md:text-4xl font-bold text-slate-900 mb-2">My Dashboard</h1>
  <p class="text-slate-600 mb-8">Manage your purchases and downloads</p>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div
      class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6 hover:shadow-xl transition-shadow duration-300">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-slate-500 uppercase tracking-wide mb-1">Total Purchases</p>
          <p id="totalPurchases"
            class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-600 to-emerald-600">0</p>
        </div>
        <div class="w-12 h-12 rounded-full bg-sky-100 flex items-center justify-center">
          <svg class="w-6 h-6 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z">
            </path>
          </svg>
        </div>
      </div>
    </div>

    <div
      class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6 hover:shadow-xl transition-shadow duration-300">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-slate-500 uppercase tracking-wide mb-1">Downloads</p>
          <p id="totalDownloads"
            class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-emerald-600 to-sky-600">0</p>
        </div>
        <div class="w-12 h-12 rounded-full bg-emerald-100 flex items-center justify-center">
          <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
          </svg>
        </div>
      </div>
    </div>

    <div
      class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6 hover:shadow-xl transition-shadow duration-300">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-slate-500 uppercase tracking-wide mb-1">Total Spent</p>
          <p id="totalSpent" class="text-3xl font-bold text-slate-900">₦0</p>
        </div>
        <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center">
          <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
            </path>
          </svg>
        </div>
      </div>
    </div>
  </div>

  <!-- My Purchases -->
  <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
    <div class="bg-gradient-to-r from-sky-600 to-emerald-600 px-6 py-4">
      <h2 class="text-xl font-bold text-white">My Purchased Projects</h2>
    </div>

    <div id="purchasesList" class="divide-y divide-slate-200">
      <!-- Loading state -->
      <div id="purchasesLoading" class="p-8 text-center">
        <div class="animate-spin w-8 h-8 border-4 border-sky-600 border-t-transparent rounded-full mx-auto mb-4"></div>
        <p class="text-slate-600">Loading your purchases...</p>
      </div>

      <!-- Empty state -->
      <div id="purchasesEmpty" class="p-8 text-center hidden">
        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-slate-100 flex items-center justify-center">
          <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-slate-900 mb-2">No Purchases Yet</h3>
        <p class="text-slate-600 mb-4">Start browsing our collection of verified projects</p>
        <a href="/projects/"
          class="inline-flex items-center justify-center px-6 py-3 rounded-lg bg-gradient-to-r from-sky-600 to-emerald-600 text-white font-semibold hover:from-sky-700 hover:to-emerald-700 transition-all duration-200">
          Browse Projects
        </a>
      </div>

      <!-- Purchases will be loaded here -->
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
  (async function () {
    const accessToken = localStorage.getItem('accessToken');
    if (!accessToken) {
      window.location.href = '/login/?next=' + encodeURIComponent(window.location.pathname);
      return;
    }

    const purchasesLoading = document.getElementById('purchasesLoading');
    const purchasesEmpty = document.getElementById('purchasesEmpty');
    const purchasesList = document.getElementById('purchasesList');

    try {
      const [purchasesResp, downloadsResp] = await Promise.all([
        fetch('/api/me/purchases/', { headers: { 'Authorization': 'Bearer ' + accessToken } }),
        fetch('/api/me/downloads/', { headers: { 'Authorization': 'Bearer ' + accessToken } }),
      ]);

      const purchases = await purchasesResp.json();
      const downloads = await downloadsResp.json();

      // Update stats
      if (Array.isArray(purchases)) {
        document.getElementById('totalPurchases').textContent = purchases.filter(p => p.status === 'PAID').length;
        const totalSpent = purchases.filter(p => p.status === 'PAID').reduce((sum, p) => sum + parseFloat(p.amount), 0);
        document.getElementById('totalSpent').textContent = '₦' + totalSpent.toFixed(2);
      }

      if (Array.isArray(downloads)) {
        document.getElementById('totalDownloads').textContent = downloads.length;
      }

      // Show purchases
      purchasesLoading.classList.add('hidden');

      if (!Array.isArray(purchases) || purchases.filter(p => p.status === 'PAID').length === 0) {
        purchasesEmpty.classList.remove('hidden');
      } else {
        const paidPurchases = purchases.filter(p => p.status === 'PAID');
        paidPurchases.forEach(purchase => {
          const purchaseEl = document.createElement('div');
          purchaseEl.className = 'p-6 hover:bg-slate-50 transition-colors duration-150';
          purchaseEl.innerHTML = `
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
              <div class="flex-1">
                <h3 class="font-semibold text-slate-900 mb-1">${purchase.project_title || 'Project #' + purchase.project}</h3>
                <div class="flex flex-wrap items-center gap-3 text-sm text-slate-600">
                  <span class="inline-flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    ${new Date(purchase.paid_at).toLocaleDateString()}
                  </span>
                  <span class="inline-flex items-center font-semibold text-emerald-600">
                    ₦${purchase.amount}
                  </span>
                  <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    Paid
                  </span>
                </div>
              </div>
              <button onclick="downloadProject(${purchase.project})" class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-sky-600 text-white text-sm font-medium hover:bg-sky-700 transition-colors duration-200">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                </svg>
                Download
              </button>
            </div>
          `;
          purchasesList.appendChild(purchaseEl);
        });
      }
    } catch (err) {
      console.error('Failed to load dashboard data', err);
      purchasesLoading.classList.add('hidden');
      purchasesList.innerHTML = '<div class="p-8 text-center text-red-600">Failed to load purchases. Please refresh the page.</div>';
    }
  })();

  async function downloadProject(projectId) {
    const accessToken = localStorage.getItem('accessToken');
    try {
      const resp = await fetch('/api/downloads/request/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + accessToken,
        },
        body: JSON.stringify({ project_id: projectId, download_type: 'document' }),
      });

      const data = await resp.json();
      if (!resp.ok) {
        alert(data.detail || 'Failed to prepare download');
        return;
      }

      window.location.href = data.download_url;
    } catch (err) {
      alert('Network error while preparing download');
    }
  }
</script>
{% endblock %}